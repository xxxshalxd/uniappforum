"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/http.js"),o=require("../../stores/user.js");if(!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-tag")+e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-input")+e.resolveComponent("u-popup"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-tag/u-tag.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js"))();const n={__name:"square",setup(n){const s=o.useUserStore(),r=e.ref([]),a=e.ref(!1),u=e.ref({title:"",content:""}),i=e.ref(!1),c=e.ref({content:""}),l=e.ref(null),p=async()=>{try{const e=(await t.http.get("/api/posts")).data.map((e=>({...e,user:null,comments:[]}))),o=e.map((e=>d(e.userId))),n=await Promise.all(o),s=e.map((e=>m(e.id))),a=await Promise.all(s);r.value=e.map(((e,t)=>({...e,user:n[t],comments:a[t]})))}catch(e){console.error("Error fetching posts:",e)}},d=async e=>{try{return(await t.http.get(`/api/users/getName?id=${e}`)).data}catch(o){return console.error("Error fetching user:",o),{}}},m=async e=>{try{return(await t.http.get("/api/comments",{params:{postId:e}})).data.map((e=>({...e,user:{username:e.user.username}})))}catch(o){return console.error("Error fetching comments:",o),[]}},v=()=>{s.isLoggedIn?a.value=!0:e.index.showToast({title:"发帖请先登录",icon:"error"})},h=async()=>{try{const o=await t.http.post("/api/posts",{...u.value,userId:s.userInfo.id});await p();const n=o.data;r.value.unshift(n),u.value={title:"",content:""},a.value=!1,e.index.showToast({title:"发帖成功",icon:"success"})}catch(o){console.error("Error submitting post:",o),e.index.showToast({title:"发帖失败",icon:"error"})}},f=async()=>{try{await t.http.post("/api/comments",{content:c.value.content,postId:l.value,userId:s.userInfo.id}),await p(),c.value={content:""},i.value=!1,e.index.showToast({title:"评论成功",icon:"success"})}catch(o){console.error("Error submitting comment:",o)}},w=e.reactive({}),g=async e=>{try{return(await t.http.get("/api/likes/count",{params:{postId:e}})).data.data}catch(o){return console.error("Error fetching like count:",o),0}};return e.onMounted((async()=>{await p(),r.value.forEach((async e=>{const t=await g(e.id);e.likesCount=t,w[e.id]=await checkLike(e.id,s.userInfo.id)}))})),(o,n)=>({a:e.p({title:"论坛广场"}),b:e.f(r.value,((o,n,a)=>e.e({a:o.user},o.user?{b:"f4c649d9-1-"+a,c:e.p({text:"作者",type:"success"}),d:e.t(o.user.username)}:{},{e:"f4c649d9-2-"+a,f:e.t(o.title),g:"f4c649d9-3-"+a,h:e.t(o.content),i:e.f(o.comments,((t,o,n)=>e.e({a:t.user},t.user?{b:"f4c649d9-4-"+a+"-"+n,c:e.p({text:"评论者",type:"success"}),d:e.t(t.user.username)}:{},{e:e.t(t.content),f:t.id}))),j:"f4c649d9-6-"+a+",f4c649d9-5-"+a,k:e.t(o.likesCount?o.likesCount:0),l:e.o((n=>(async o=>{if(s.isLoggedIn)try{const n=(await t.http.post("/api/likes/toggle",{postId:o,userId:s.userInfo.id},{headers:{"Content-Type":"application/json"}})).data.data;w[o]=n;const a=await g(o),u=r.value.findIndex((e=>e.id===o));-1!==u&&(r.value[u].likesCount=a);const i=n?"点赞成功":"取消点赞";e.index.showToast({title:i,icon:n?"success":"error"})}catch(n){console.error("Error toggling like:",n)}else e.index.showToast({title:"请先登录",icon:"error"})})(o.id)),o.id),m:"f4c649d9-5-"+a,n:e.o((t=>{return n=o.id,void(s.isLoggedIn?(l.value=n,i.value=!0):e.index.showToast({title:"评论请先登录",icon:"error"}));var n}),o.id),o:"f4c649d9-7-"+a,p:o.id}))),c:e.p({text:"标题",type:"success"}),d:e.p({text:"内容",type:"success"}),e:e.p({name:"thumb-up"}),f:e.p({ripple:"true"}),g:e.o(v),h:e.p({type:"primary"}),i:e.o((e=>u.value.title=e)),j:e.p({placeholder:"帖子标题",modelValue:u.value.title}),k:u.value.content,l:e.o((e=>u.value.content=e.detail.value)),m:e.o(h),n:e.o((e=>a.value=e)),o:e.p({position:"center",mode:"center",modelValue:a.value}),p:e.o((e=>c.value.content=e)),q:e.p({placeholder:"评论内容",modelValue:c.value.content}),r:e.o(f),s:e.o((e=>i.value=e)),t:e.p({position:"center",mode:"center",modelValue:i.value})})}},s=e._export_sfc(n,[["__scopeId","data-v-f4c649d9"]]);wx.createPage(s);
